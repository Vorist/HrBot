import re

# --- ĞšĞ»ÑÑ‡Ğ¾Ğ²Ñ– ÑĞ»Ğ¾Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ñ–Ğ´Ğ¾Ğ·Ñ€Ğ¸ --- #
SUSPICION_KEYWORDS = [
    "Ñ†Ğµ ÑĞºĞ°Ğ¼", "Ğ²Ñ‹ ÑĞºĞ°Ğ¼", "Ñ‰Ğ¾ Ğ·Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ñ–Ñ", "Ğ´Ğµ Ğ¿Ñ€Ğ°Ñ†ÑÑ”Ñ‚Ğµ", "Ğ»ĞµĞ³Ğ°Ğ»ÑŒĞ½Ğ¾?", "Ñ†Ğµ Ğ¾Ğ±Ğ¼Ğ°Ğ½",
    "Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµĞ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğ°", "Ñ†Ğµ Ğ½Ğµ Ñ‡Ğ¾Ñ€Ğ½Ğ° ÑÑ…ĞµĞ¼Ğ°?", "Ñ‡Ğ¸ Ğ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğ¾", "Ğ° Ñ‰Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾ Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸",
    "Ñ‰Ğ¾ Ğ·Ğ° ÑˆĞ°Ñ…Ñ€Ğ°Ğ¹ÑÑ‚Ğ²Ğ¾", "Ğ° ÑĞºÑ‰Ğ¾ Ğ¼ĞµĞ½Ğµ Ğ¿Ğ¾ÑĞ°Ğ´ÑÑ‚ÑŒ", "Ğ²Ñ–Ğ´Ğ¼Ğ¸Ğ²Ğ°Ğ½Ğ½Ñ Ğ³Ñ€Ğ¾ÑˆĞµĞ¹"
]

# --- Ğ Ğ¾Ğ·Ğ¿Ñ–Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ Ğ½Ğ° Ñ€Ğ¾ÑÑ–Ğ¹ÑÑŒĞºÑƒ Ğ¼Ğ¾Ğ²Ñƒ --- #
RU_KEYWORDS = ["Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸", "Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼", "Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ñ€ÑƒÑ", "Ğ´Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸", "Ğ¿Ğ¾ Ñ€ÑƒÑÑĞºĞ¸", "Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹"]

# --- Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ --- #
FORMAL_KEYWORDS = [
    "Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚", "ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚", "Ğ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğ¾", "Ğ»Ñ–Ñ†ĞµĞ½Ğ·Ñ–Ñ", "Ğ·Ğ°ĞºĞ¾Ğ½", "ÑÑ€Ğ¸Ğ´Ğ¸Ñ‡Ğ½Ğ¾", "Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ½Ñ", "Ğ¾Ñ„Ñ–Ñ†Ñ–Ğ¹Ğ½Ğµ Ğ¿Ñ€Ğ°Ñ†ĞµĞ²Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ"
]

# --- Ğ”Ñ€ÑƒĞ¶Ğ½Ñ–Ğ¹ / Ñ€Ğ¾Ğ·Ğ¼Ğ¾Ğ²Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ --- #
CASUAL_KEYWORDS = [
    "Ğ¹Ğ¾", "Ñ‡ÑƒĞ²Ğ°Ğº", "Ğ¿Ğ¾Ğ³Ğ½Ğ°Ğ»Ğ¸", "Ğ²Ğ¿Ñ”Ñ€ÑŒĞ¾Ğ´", "ÑˆĞ¾ Ñ‚Ğ°Ğ¼", "ÑÑĞ½Ğ¾", "Ñ‚Ğ° Ğ»Ğ°Ğ´Ğ½Ğ¾", "Ğ½Ñƒ", "Ğ°Ğ³Ğ°", "Ğ¼Ğ¼Ğ¼", "Ğ¾ĞºĞµĞ¹", "Ğ½Ñ–Ñ‡Ğ¾", "Ğ´Ğ¾Ğ±Ñ€ĞµĞ½ÑŒĞºĞ¾"
]

# --- Ğ“ÑƒĞ¼Ğ¾Ñ€ / ĞµĞ¼Ğ¾Ğ´Ğ·Ñ– --- #
HUMOR_KEYWORDS = [
    "Ğ¶Ğ°Ñ€Ñ‚", "Ğ¿Ñ€Ğ¸ĞºĞ¾Ğ»", "Ğ°Ñ…Ğ°Ñ…", "Ğ»Ğ¾Ğ»", "Ñ€Ğ¶ÑƒĞ½Ñ–Ğ¼Ğ°Ğ³Ñƒ", "Ñ…Ğ°-Ñ…Ğ°", "Ñ…Ğ°", "ğŸ˜†", "ğŸ˜‚", "ğŸ˜„", "ğŸ¤£", "ÑĞ¼Ñ–ÑˆĞ½Ğ¾"
]


def detect_meta_flags(text: str) -> dict:
    """
    Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ” Ğ¼ĞµÑ‚Ğ°-Ñ„Ğ»Ğ°Ğ³Ğ¸ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ñ– Ğ·Ğ¼Ñ–ÑÑ‚Ñƒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°.
    """
    flags = {}
    text = text.lower()

    if any(x in text for x in SUSPICION_KEYWORDS):
        flags["suspicion"] = True
    if any(x in text for x in RU_KEYWORDS):
        flags["lang"] = "ru"
    if any(x in text for x in FORMAL_KEYWORDS):
        flags["tone"] = "formal"
    elif any(x in text for x in CASUAL_KEYWORDS):
        flags["tone"] = "casual"
    if any(x in text for x in HUMOR_KEYWORDS):
        flags["humor"] = True

    return flags


def update_meta(memory: dict, chat_id: int | str, flags: dict):
    str_id = str(chat_id)
    if str_id not in memory:
        memory[str_id] = {"dialog": [], "_meta": {}}
    if "_meta" not in memory[str_id]:
        memory[str_id]["_meta"] = {}
    memory[str_id]["_meta"].update(flags)


def get_meta(memory: dict, chat_id: int | str) -> dict:
    return memory.get(str(chat_id), {}).get("_meta", {})
